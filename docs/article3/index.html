<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ISS 現在地 3D 可視化（Three.js r146）</title>
<style>
  html, body { margin: 0; height: 100%; background: #000; color: #fff; font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; }
  #app { position: relative; height: 100%; }
  canvas { display: block; }
  .ui {
    position: absolute; inset: 12px 12px auto 12px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.15); border-radius: 12px; padding: 8px 10px; backdrop-filter: blur(6px);
  }
  .chip { padding: 4px 8px; border: 1px solid rgba(255,255,255,.2); border-radius: 999px; font-size: 12px; opacity: .9; }
  .btn { appearance: none; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.1); color: #fff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
  .btn:hover { background: rgba(255,255,255,.18); }
  .credit { position: absolute; inset: auto 12px 12px 12px; font-size: 12px; opacity: .8; line-height: 1.6; }
</style>
<!-- Three.js r146（グローバル版） -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/build/three.min.js"></script>
<!-- OrbitControls（グローバル用） -->
<script src="https://cdn.jsdelivr.net/npm/three@0.146.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
<div id="app">
  <div class="ui">
    <span class="chip" id="lat">lat: --</span>
    <span class="chip" id="lon">lon: --</span>
    <span class="chip" id="alt">alt(km): --</span>
    <span class="chip" id="updated">更新: --</span>
    <button class="btn" id="recenter">ISSへ</button>
    <button class="btn" id="toggleHD">HD</button>
    <button class="btn" id="toggleClouds">雲 ON/OFF</button>
    <button class="btn" id="toggleAtmos">大気 ON/OFF</button>
    <button class="btn" id="toggleStars">星 ON/OFF</button>
  </div>
  <div class="credit">
    Data: Where The ISS At? API（https://wheretheiss.at） / Textures: threejs.org examples<br/>
    Three.js © mrdoob | 操作: ドラッグで回転・ホイールでズーム
  </div>
</div>

<script>
/* ============ 基本セットアップ ============ */
const app = document.getElementById('app');
const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(window.innerWidth, window.innerHeight);
app.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(55, window.innerWidth/window.innerHeight, 0.1, 4000);
camera.position.set(0, 0, 9);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.06;
controls.minDistance = 3.5;
controls.maxDistance = 60;

/* ライト（太陽っぽい向き） */
const ambient = new THREE.AmbientLight(0xffffff, 0.55);
scene.add(ambient);
const sun = new THREE.DirectionalLight(0xffffff, 1.2);
sun.position.set(10, 5, 8);
scene.add(sun);

/* ============ 地球：テクスチャ＋雲＋大気 ============ */
const R = 3; // 地球半径（任意単位）
const loader = new THREE.TextureLoader();
loader.setCrossOrigin('anonymous');

const texDay   = loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg');
const texNight = loader.load('https://threejs.org/examples/textures/planets/earth_lights_2048.png');
const texSpec  = loader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg');
const texCloud = loader.load('https://threejs.org/examples/textures/planets/earth_clouds_1024.png');

[texDay, texNight, texSpec, texCloud].forEach(t => { t.anisotropy = Math.min(8, renderer.capabilities.getMaxAnisotropy()); });

const earth = new THREE.Mesh(
  new THREE.SphereGeometry(R, 96, 96),
  new THREE.MeshPhongMaterial({
    map: texDay,
    specularMap: texSpec,
    specular: new THREE.Color(0x333333),
    shininess: 12,
    emissiveMap: texNight,
    emissive: new THREE.Color(0x222222),
    emissiveIntensity: 1.0
  })
);
scene.add(earth);

/* 経緯線（細めのワイヤーフレーム） */
const grid = new THREE.LineSegments(
  new THREE.WireframeGeometry(new THREE.SphereGeometry(R*1.001, 32, 22)),
  new THREE.LineBasicMaterial({ color: 0x2f4f80, transparent: true, opacity: 0.35 })
);
scene.add(grid);

/* 雲レイヤ（少し大きめ & 加算系でフワッと） */
const clouds = new THREE.Mesh(
  new THREE.SphereGeometry(R*1.006, 96, 96),
  new THREE.MeshLambertMaterial({
    map: texCloud,
    transparent: true,
    opacity: 0.9,
    depthWrite: false
  })
);
scene.add(clouds);

/* フェイク大気（外向きBackSide＋加算合成） */
const atmosphere = new THREE.Mesh(
  new THREE.SphereGeometry(R*1.02, 64, 64),
  new THREE.MeshBasicMaterial({
    color: 0x4aa3ff,
    transparent: true,
    opacity: 0.12,
    blending: THREE.AdditiveBlending,
    side: THREE.BackSide,
    depthWrite: false
  })
);
scene.add(atmosphere);

/* ============ 背景の星（粒子＋薄い銀河帯） ============ */
const starGeo = new THREE.BufferGeometry();
const STAR_N = 2000;
const starPos = new Float32Array(STAR_N * 3);
for (let i=0; i<STAR_N; i++){
  const r = 1000 * Math.cbrt(Math.random());
  const th = Math.random()*Math.PI*2;
  const ph = Math.acos(2*Math.random()-1);
  starPos[i*3+0] = r * Math.sin(ph)*Math.cos(th);
  starPos[i*3+1] = r * Math.sin(ph)*Math.sin(th);
  starPos[i*3+2] = r * Math.cos(ph);
}
starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0x88aaff, size: 1.0, sizeAttenuation: false, opacity:.9, transparent:true }));
scene.add(stars);

// 銀河“帯”の薄い板（雰囲気出し）
const nebula = new THREE.Mesh(
  new THREE.PlaneGeometry(3000, 1200, 1, 1),
  new THREE.MeshBasicMaterial({ color: 0x1f2b50, transparent: true, opacity: 0.15 })
);
nebula.rotation.x = -Math.PI/2.6;
nebula.position.y = -600;
scene.add(nebula);

/* ============ ISS マーカー＆軌跡 ============ */
const issGroup = new THREE.Group(); scene.add(issGroup);
const issPoint = new THREE.Points(
  new THREE.BufferGeometry().setAttribute('position', new THREE.Float32BufferAttribute([0,0,0], 3)),
  new THREE.PointsMaterial({ color: 0xfff2a8, size: 0.22 })
);
issGroup.add(issPoint);

const trailMax = 350;
const trailGeo = new THREE.BufferGeometry();
const trailPos = new Float32Array(trailMax * 3);
trailGeo.setAttribute('position', new THREE.BufferAttribute(trailPos, 3));
const trail = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({ color: 0xffcc66, transparent: true, opacity: 0.9 }));
issGroup.add(trail);
let trailIndex = 0;

/* ============ 緯度経度→3D座標 ============ */
function llhToVec3(latDeg, lonDeg, altKm){
  const lat = THREE.MathUtils.degToRad(latDeg);
  const lon = THREE.MathUtils.degToRad(lonDeg);
  const altScale = 1 + (altKm || 0)/6371; // 地球半径で正規化
  const r = R * altScale + 0.02;
  return new THREE.Vector3(
    r * Math.cos(lat) * Math.cos(lon),
    r * Math.sin(lat),
    r * Math.cos(lat) * Math.sin(lon)
  );
}

/* ============ UIと状態 ============ */
const ui = {
  lat: document.getElementById('lat'),
  lon: document.getElementById('lon'),
  alt: document.getElementById('alt'),
  upd: document.getElementById('updated'),
  recenter: document.getElementById('recenter'),
  hd: document.getElementById('toggleHD'),
  clouds: document.getElementById('toggleClouds'),
  atmos: document.getElementById('toggleAtmos'),
  stars: document.getElementById('toggleStars'),
};
let lastISSPos = new THREE.Vector3();
let hdOn = true;

ui.recenter.addEventListener('click', ()=>{
  controls.target.set(0,0,0);
  camera.position.copy(lastISSPos.clone().setLength(R + 4.5));
});
ui.hd.addEventListener('click', ()=>{
  hdOn = !hdOn;
  renderer.setPixelRatio(hdOn ? Math.min(devicePixelRatio, 2) : 1);
});
ui.clouds.addEventListener('click', ()=>{ clouds.visible = !clouds.visible; });
ui.atmos.addEventListener('click', ()=>{ atmosphere.visible = !atmosphere.visible; });
ui.stars.addEventListener('click', ()=>{ stars.visible = !stars.visible; nebula.visible = !nebula.visible; });

/* ============ API: Where The ISS At? ============ */
async function fetchISS(){
  try{
    const res = await fetch('https://api.wheretheiss.at/v1/satellites/25544', { cache: 'no-store' });
    const data = await res.json();
    const { latitude, longitude, altitude, timestamp } = data;

    ui.lat.textContent = `lat: ${latitude.toFixed(3)}`;
    ui.lon.textContent = `lon: ${longitude.toFixed(3)}`;
    ui.alt.textContent = `alt(km): ${altitude.toFixed(1)}`;
    ui.upd.textContent = `更新: ${new Date(timestamp*1000).toLocaleTimeString()}`;

    const p = llhToVec3(latitude, longitude, altitude);
    lastISSPos.copy(p);
    issPoint.geometry.attributes.position.set([p.x, p.y, p.z], 0);
    issPoint.geometry.attributes.position.needsUpdate = true;

    // 軌跡更新（リングバッファ）
    trailPos[(trailIndex%trailMax)*3+0] = p.x;
    trailPos[(trailIndex%trailMax)*3+1] = p.y;
    trailPos[(trailIndex%trailMax)*3+2] = p.z;
    trailIndex++;
    trail.geometry.attributes.position.needsUpdate = true;

  } catch(e){
    ui.upd.textContent = '更新: 失敗';
    console.error(e);
  }
}
fetchISS();
setInterval(fetchISS, 5000);

/* ============ アニメ＆リサイズ ============ */
function animate(){
  requestAnimationFrame(animate);

  // 自転：地球・雲・グリッド
  const rot = 0.0005;
  earth.rotation.y += rot;
  grid.rotation.y   = earth.rotation.y;
  clouds.rotation.y += rot * 1.4;

  // 星・銀河 ほんの少し動かしてパララックス感
  stars.rotation.y  += 0.00005;
  nebula.rotation.z += 0.00002;

  controls.update();
  renderer.render(scene, camera);
}
animate();

addEventListener('resize', ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});
</script>
</body>
</html>
